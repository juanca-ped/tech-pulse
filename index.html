<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Pulse ‚Äî Your Daily Tech News Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #1a1d27;
            --bg-card: #21242f;
            --bg-card-hover: #282c3a;
            --accent: #6c63ff;
            --accent-light: #8b83ff;
            --text-primary: #e8e9ed;
            --text-secondary: #9499a8;
            --text-muted: #6b7185;
            --border: #2a2e3b;
            --success: #34d399;
            --linkedin: #0077b5;
            --twitter: #1da1f2;
            --threads: #000000;
            --gradient-1: linear-gradient(135deg, #6c63ff, #4ecdc4);
            --gradient-2: linear-gradient(135deg, #ff6b6b, #ffa07a);
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 20px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: -2px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .last-updated {
            font-size: 13px;
            color: var(--text-muted);
        }

        .refresh-btn {
            background: var(--gradient-1);
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(108,99,255,0.4);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .refresh-btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .refresh-btn.loading .spinner { display: inline-block; }
        .refresh-btn.loading .btn-text { display: none; }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Topic Selector */
        .topic-bar {
            padding: 14px 40px;
            display: flex;
            gap: 12px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            flex-wrap: wrap;
        }

        .topic-bar .bar-label {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .topic-select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            min-width: 220px;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239499a8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .topic-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(108,99,255,0.2);
        }

        .topic-select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .lang-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        .lang-toggle .bar-label {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .lang-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .lang-btn:hover { border-color: var(--accent); color: var(--text-primary); }
        .lang-btn.active { background: var(--accent); border-color: var(--accent); color: white; }

        /* Source Multi-Select Dropdown */
        .source-bar {
            padding: 14px 40px;
            display: flex;
            gap: 12px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            flex-wrap: wrap;
        }

        .source-bar .bar-label {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .source-dropdown {
            position: relative;
            min-width: 280px;
        }

        .source-dropdown-trigger {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 36px 8px 14px;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            width: 100%;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239499a8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .source-dropdown-trigger:hover { border-color: var(--accent); }
        .source-dropdown-trigger.open { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(108,99,255,0.2); }

        .source-dropdown-panel {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            min-width: 320px;
            max-height: 420px;
            overflow-y: auto;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
            z-index: 90;
            padding: 8px 0;
        }

        .source-dropdown-panel.open { display: block; }

        .source-dropdown-panel::-webkit-scrollbar { width: 6px; }
        .source-dropdown-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        .src-group-label {
            padding: 8px 16px 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .src-group-label:not(:first-child) {
            border-top: 1px solid var(--border);
            margin-top: 4px;
            padding-top: 10px;
        }

        .src-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 16px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .src-option:hover { background: rgba(108,99,255,0.08); color: var(--text-primary); }

        .src-option input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 4px;
            background: var(--bg-secondary);
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
            transition: all 0.15s;
        }

        .src-option input[type="checkbox"]:checked {
            background: var(--accent);
            border-color: var(--accent);
        }

        .src-option input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 3px;
            top: 0px;
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .src-option .src-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .src-actions {
            display: flex;
            gap: 4px;
            padding: 6px 12px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 4px;
        }

        .src-actions button {
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .src-actions button:hover { border-color: var(--accent); color: var(--accent-light); }

        .source-count-badge {
            background: var(--accent);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 4px;
        }

        /* Main Content */
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 40px;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .stat {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-number {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-light);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .active-topic-badge {
            background: rgba(108,99,255,0.15);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-light);
        }

        .active-topic-badge .topic-icon { font-size: 18px; }

        /* News Cards */
        .news-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .news-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 24px;
            transition: all 0.2s;
            position: relative;
        }

        .news-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .card-top-row {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .card-rank {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-muted);
            min-width: 36px;
            text-align: center;
            line-height: 1;
            padding-top: 4px;
        }

        .card-rank.top3 {
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card-content { flex: 1; }

        .card-source-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .source-badge {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 3px 10px;
            border-radius: 4px;
            background: rgba(108,99,255,0.15);
            color: var(--accent-light);
        }

        .card-time {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .card-time .pub-date {
            color: var(--text-secondary);
            font-weight: 500;
        }
        .card-time .time-sep {
            color: var(--border);
        }

        .card-headline {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .card-headline a { color: inherit; text-decoration: none; }
        .card-headline a:hover { color: var(--accent-light); }

        .card-summary {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 4px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            padding-top: 4px;
        }

        .share-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .share-btn:hover { border-color: var(--accent); color: var(--accent-light); }
        .share-btn.linkedin:hover { border-color: var(--linkedin); color: var(--linkedin); background: rgba(0,119,181,0.1); }
        .share-btn.twitter:hover { border-color: var(--twitter); color: var(--twitter); background: rgba(29,161,242,0.1); }
        .share-btn.threads:hover { border-color: #e0e0e0; color: #e0e0e0; background: rgba(255,255,255,0.08); }
        .share-btn.copy:hover { border-color: var(--success); color: var(--success); background: rgba(52,211,153,0.1); }

        .share-btn.summary-btn { width: auto; padding: 0 12px; gap: 5px; font-size: 12px; font-weight: 600; }
        .share-btn.summary-btn:hover { border-color: var(--warning); color: var(--warning); background: rgba(245,158,11,0.1); }
        .share-btn.summary-btn.loading-summary { opacity: 0.6; pointer-events: none; }

        /* Inline summary expansion */
        .card-ai-summary {
            margin-top: 12px;
            padding: 14px 16px;
            background: rgba(108,99,255,0.06);
            border: 1px solid rgba(108,99,255,0.2);
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            animation: fadeSlide 0.3s ease;
        }

        .card-ai-summary .summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .card-ai-summary .summary-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-light);
        }

        .card-ai-summary .summary-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .card-ai-summary .summary-close:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }

        .card-ai-summary .summary-text { color: var(--text-secondary); }

        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title { font-size: 20px; font-weight: 700; }

        .modal-close {
            width: 32px; height: 32px; border-radius: 8px;
            border: none; background: var(--bg-card); color: var(--text-secondary);
            cursor: pointer; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
        }

        .modal-tabs {
            display: flex; gap: 4px; margin-bottom: 20px;
            background: var(--bg-card); border-radius: 8px; padding: 4px;
        }

        .modal-tab {
            flex: 1; padding: 10px; border: none; background: none;
            color: var(--text-muted); border-radius: 6px; cursor: pointer;
            font-size: 14px; font-weight: 600; transition: all 0.2s;
        }

        .modal-tab.active { background: var(--accent); color: white; }

        .post-preview {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 10px; padding: 20px; margin-bottom: 16px;
        }

        .post-preview textarea {
            width: 100%; background: none; border: none; color: var(--text-primary);
            font-size: 14px; line-height: 1.6; resize: vertical; min-height: 140px; font-family: inherit;
        }

        .post-preview textarea:focus { outline: none; }

        .char-count { font-size: 12px; color: var(--text-muted); text-align: right; margin-top: 8px; }
        .char-count.over { color: #ff6b6b; }

        .modal-actions { display: flex; gap: 10px; }

        .modal-btn {
            flex: 1; padding: 12px; border-radius: 8px; font-size: 14px;
            font-weight: 600; cursor: pointer; border: none; transition: all 0.2s;
        }

        .modal-btn.primary { background: var(--gradient-1); color: white; }
        .modal-btn.secondary { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); }
        .modal-btn:hover { transform: translateY(-1px); }

        /* Loading State */
        .loading-container {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 80px 20px; gap: 20px;
        }

        .loading-dots { display: flex; gap: 8px; }

        .loading-dots span {
            width: 12px; height: 12px; background: var(--accent);
            border-radius: 50%; animation: bounce 1.4s ease-in-out infinite;
        }

        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }

        .loading-text { color: var(--text-muted); font-size: 14px; }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; right: 30px; background: var(--success);
            color: #0f1117; padding: 12px 24px; border-radius: 8px; font-size: 14px;
            font-weight: 600; transform: translateY(100px); opacity: 0;
            transition: all 0.3s; z-index: 300;
        }

        .toast.show { transform: translateY(0); opacity: 1; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

        /* Responsive */
        @media (max-width: 768px) {
            .header { padding: 16px 20px; flex-wrap: wrap; gap: 12px; }
            .topic-bar { padding: 12px 20px; }
            .source-bar { padding: 12px 20px; }
            .main { padding: 20px; }
            .card-top-row { flex-direction: column; gap: 12px; }
            .card-actions { align-self: flex-end; }
            .card-rank { min-width: auto; }
            .stats-bar { flex-wrap: wrap; }
            .lang-toggle { margin-left: 0; }
            .topic-select { min-width: 160px; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">‚ö°</div>
            <div>
                <div class="logo-text">Tech Pulse</div>
                <div class="logo-subtitle">Your personalized tech news feed</div>
            </div>
        </div>
        <div class="header-actions">
            <span class="last-updated" id="lastUpdated">Not yet refreshed</span>
            <button class="refresh-btn" id="refreshBtn" onclick="fetchNews()">
                <span class="spinner"></span>
                <span class="btn-text">üîÑ Fetch Latest News</span>
            </button>
        </div>
    </header>

    <!-- Topic + Language Bar -->
    <div class="topic-bar">
        <span class="bar-label">Topic:</span>
        <select class="topic-select" id="topicSelect" onchange="onTopicChange()">
            <option value="all">üåê All Technology</option>
            <optgroup label="Core Tech">
                <option value="artificial intelligence">ü§ñ Artificial Intelligence</option>
                <option value="machine learning">üß† Machine Learning</option>
                <option value="generative AI">‚ú® Generative AI</option>
                <option value="robotics">ü¶æ Robotics</option>
            </optgroup>
            <optgroup label="Devices & Platforms">
                <option value="mobile">üì± Mobile / Smartphones</option>
                <option value="apple">üçé Apple</option>
                <option value="android google">ü§ñ Android / Google</option>
                <option value="wearables">‚åö Wearables</option>
                <option value="gaming">üéÆ Gaming</option>
                <option value="electric vehicles">üöó Electric Vehicles</option>
            </optgroup>
            <optgroup label="Software & Cloud">
                <option value="cloud computing">‚òÅÔ∏è Cloud Computing</option>
                <option value="SaaS software">üíª SaaS / Software</option>
                <option value="programming developer">üë®‚Äçüíª Programming / Dev Tools</option>
                <option value="open source">üì¶ Open Source</option>
            </optgroup>
            <optgroup label="Internet & Social">
                <option value="social media">üì£ Social Media</option>
                <option value="streaming media">üì∫ Streaming / Media</option>
                <option value="ecommerce">üõí E-Commerce</option>
                <option value="fintech cryptocurrency">üí∞ Fintech / Crypto</option>
            </optgroup>
            <optgroup label="Enterprise & Industry">
                <option value="cybersecurity">üîí Cybersecurity</option>
                <option value="data privacy">üõ°Ô∏è Data Privacy</option>
                <option value="semiconductors chips">üî¨ Semiconductors / Chips</option>
                <option value="startups venture capital">üöÄ Startups / VC</option>
                <option value="big tech FAANG">üè¢ Big Tech (FAANG)</option>
            </optgroup>
            <optgroup label="Advertising & Marketing">
                <option value="advertising marketing">üì¢ Advertising & Marketing</option>
                <option value="brand marketing">üè∑Ô∏è Brand Marketing</option>
                <option value="digital advertising adtech">üìä Digital Ads / AdTech</option>
                <option value="influencer creator economy">üé§ Influencer / Creator Economy</option>
            </optgroup>
            <optgroup label="Television & Streaming">
                <option value="television streaming">üì∫ Television & Streaming</option>
                <option value="streaming wars">‚öîÔ∏è Streaming Wars</option>
                <option value="connected TV advertising">üì° Connected TV / CTV Ads</option>
            </optgroup>
            <optgroup label="AI Deep Dive">
                <option value="AI blogs research">üî¨ AI Blogs & Research</option>
                <option value="AI startups tools">üõ†Ô∏è AI Startups & Tools</option>
                <option value="AI regulation policy">‚öñÔ∏è AI Regulation & Policy</option>
            </optgroup>
            <optgroup label="Frontier Tech">
                <option value="space technology">üöÄ Space Tech</option>
                <option value="quantum computing">‚öõÔ∏è Quantum Computing</option>
                <option value="biotech health tech">üß¨ Biotech / Health Tech</option>
                <option value="AR VR metaverse">ü•Ω AR / VR / Metaverse</option>
                <option value="blockchain web3">üîó Blockchain / Web3</option>
            </optgroup>
        </select>

        <div class="lang-toggle">
            <span class="bar-label">Summaries:</span>
            <button class="lang-btn active" data-lang="en" onclick="setLanguage('en', this)">EN</button>
            <button class="lang-btn" data-lang="es" onclick="setLanguage('es', this)">ES</button>
        </div>
    </div>

    <!-- Source Multi-Select Dropdown -->
    <div class="source-bar">
        <span class="bar-label">Sources:</span>
        <div class="source-dropdown" id="sourceDropdown">
            <button class="source-dropdown-trigger" id="sourceTrigger" onclick="toggleSourceDropdown()">
                All Sources Selected <span class="source-count-badge" id="sourceCountBadge">21</span>
            </button>
            <div class="source-dropdown-panel" id="sourcePanel">
                <div class="src-actions">
                    <button onclick="selectAllSources()">Select All</button>
                    <button onclick="deselectAllSources()">Deselect All</button>
                </div>
                <div id="sourceCheckboxes"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <div class="stats-bar" id="statsBar" style="display:none;">
            <div class="stat">
                <span class="stat-number" id="statArticles">0</span>
                <span class="stat-label">Articles</span>
            </div>
            <div class="stat">
                <span class="stat-number" id="statSources">0</span>
                <span class="stat-label">Sources</span>
            </div>
            <div class="active-topic-badge" id="topicBadge" style="display:none;">
                <span class="topic-icon" id="topicBadgeIcon">üåê</span>
                <span id="topicBadgeText">All Technology</span>
            </div>
        </div>

        <div id="newsContainer">
            <div class="empty-state">
                <div class="icon">üì°</div>
                <h2 style="margin-bottom:8px; color:var(--text-primary);">Ready to fetch the latest tech news</h2>
                <p>Choose a <strong>topic</strong> from the dropdown above, then click <strong>"Fetch Latest News"</strong>.</p>
            </div>
        </div>
    </main>

    <!-- Social Post Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Generate Social Post</span>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" data-platform="linkedin" onclick="switchTab('linkedin', this)">LinkedIn</button>
                <button class="modal-tab" data-platform="twitter" onclick="switchTab('twitter', this)">X (Twitter)</button>
                <button class="modal-tab" data-platform="threads" onclick="switchTab('threads', this)">Threads</button>
            </div>
            <div class="post-preview">
                <textarea id="postText" oninput="updateCharCount()"></textarea>
                <div class="char-count" id="charCount">0 / 280</div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="copyPost()">üìã Copy to Clipboard</button>
                <button class="modal-btn primary" onclick="openPlatform()">üöÄ Open & Paste</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">Copied to clipboard!</div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const NEWS_SOURCES = [
            { name: 'Techmeme', slug: 'techmeme', rss: 'https://www.techmeme.com/feed.xml', color: '#ff6b6b', url: 'https://www.techmeme.com' },
            { name: 'TechCrunch', slug: 'techcrunch', rss: 'https://techcrunch.com/feed/', color: '#00d084', url: 'https://techcrunch.com' },
            { name: 'The Verge', slug: 'theverge', rss: 'https://www.theverge.com/rss/index.xml', color: '#fa4b2a', url: 'https://www.theverge.com' },
            { name: 'Bloomberg', slug: 'bloomberg', rss: 'https://feeds.bloomberg.com/technology/news.rss', color: '#5b2bff', url: 'https://www.bloomberg.com' },
            { name: 'WSJ', slug: 'wsj', rss: 'https://feeds.content.dowjones.io/public/rss/RSSMarketsMain', color: '#0274b6', url: 'https://www.wsj.com' },
            { name: 'ZDNet', slug: 'zdnet', rss: 'https://www.zdnet.com/news/rss.xml', color: '#e6342d', url: 'https://www.zdnet.com' },
            { name: 'Axios', slug: 'axios', rss: 'https://api.axios.com/feed/top', color: '#29aae1', url: 'https://www.axios.com' },
            { name: 'Google News Tech', slug: 'googlenews', rss: 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGRqTVhZU0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en', color: '#4285f4', url: 'https://news.google.com' },
            // ‚Äî Advertising & Marketing ‚Äî
            { name: 'Adweek', slug: 'adweek', rss: 'https://www.adweek.com/feed/', color: '#e4002b', url: 'https://www.adweek.com' },
            { name: 'Ad Age', slug: 'adage', rss: 'https://adage.com/rss-feed', color: '#ff5a00', url: 'https://adage.com' },
            { name: 'Marketing Dive', slug: 'marketingdive', rss: 'https://www.marketingdive.com/feeds/news/', color: '#1a73e8', url: 'https://www.marketingdive.com' },
            { name: 'Digiday', slug: 'digiday', rss: 'https://digiday.com/feed/', color: '#000000', url: 'https://digiday.com' },
            // ‚Äî Television & Streaming ‚Äî
            { name: 'Variety', slug: 'variety', rss: 'https://variety.com/feed/', color: '#e71d36', url: 'https://variety.com' },
            { name: 'Deadline', slug: 'deadline', rss: 'https://deadline.com/feed/', color: '#c41230', url: 'https://deadline.com' },
            { name: 'Hollywood Reporter', slug: 'hollywoodreporter', rss: 'https://www.hollywoodreporter.com/c/tv/feed/', color: '#0d0d0d', url: 'https://www.hollywoodreporter.com' },
            { name: 'TVRev', slug: 'tvrev', rss: 'https://www.tvrev.com/feed/', color: '#6b21a8', url: 'https://www.tvrev.com' },
            // ‚Äî AI-Specific Blogs ‚Äî
            { name: 'The Neuron', slug: 'theneuron', rss: 'https://www.theneurondaily.com/feed', color: '#facc15', url: 'https://www.theneurondaily.com' },
            { name: 'OpenAI Blog', slug: 'openai', rss: 'https://openai.com/blog/rss.xml', color: '#10a37f', url: 'https://openai.com/blog' },
            { name: 'MIT Tech Review AI', slug: 'mittechreview', rss: 'https://www.technologyreview.com/feed/', color: '#9b1deb', url: 'https://www.technologyreview.com' },
            { name: 'VentureBeat AI', slug: 'venturebeat', rss: 'https://venturebeat.com/category/ai/feed/', color: '#d63384', url: 'https://venturebeat.com' },
            { name: 'AI Blog (Google)', slug: 'googleblog', rss: 'https://blog.google/technology/ai/rss/', color: '#34a853', url: 'https://blog.google/technology/ai/' }
        ];

        const CORS_PROXY = 'https://api.rss2json.com/v1/api.json?rss_url=';

        let allArticles = [];
        let displayedArticles = [];
        let currentPlatform = 'linkedin';
        let currentArticle = null;
        let currentLanguage = 'en';
        let currentTopic = 'all';

        // =============================================
        // TOPIC KEYWORDS for filtering
        // =============================================
        const TOPIC_KEYWORDS = {
            'artificial intelligence': ['ai', 'artificial intelligence', 'openai', 'chatgpt', 'claude', 'anthropic', 'deepmind', 'neural', 'llm', 'gpt', 'gemini', 'copilot'],
            'machine learning': ['machine learning', 'ml', 'deep learning', 'training', 'model', 'neural network', 'tensorflow', 'pytorch'],
            'generative AI': ['generative', 'chatgpt', 'dall-e', 'midjourney', 'stable diffusion', 'llm', 'gpt', 'claude', 'gemini', 'ai generated', 'text-to', 'image generation', 'copilot'],
            'robotics': ['robot', 'robotics', 'autonomous', 'drone', 'humanoid', 'boston dynamics', 'automation'],
            'mobile': ['mobile', 'smartphone', 'iphone', 'android', 'samsung', 'pixel', 'phone', 'cellular', '5g', 'app store', 'play store'],
            'apple': ['apple', 'iphone', 'ipad', 'mac', 'macbook', 'ios', 'macos', 'vision pro', 'airpods', 'apple watch', 'wwdc', 'tim cook', 'siri'],
            'android google': ['android', 'google', 'pixel', 'chrome', 'play store', 'chromebook', 'wear os', 'sundar pichai', 'alphabet'],
            'wearables': ['wearable', 'smartwatch', 'apple watch', 'fitbit', 'garmin', 'ring', 'glasses', 'headset'],
            'gaming': ['gaming', 'game', 'xbox', 'playstation', 'nintendo', 'steam', 'esports', 'gpu', 'console', 'switch', 'ps5'],
            'electric vehicles': ['ev', 'electric vehicle', 'tesla', 'rivian', 'lucid', 'charging', 'battery', 'autonomous driving', 'self-driving', 'waymo'],
            'cloud computing': ['cloud', 'aws', 'azure', 'gcp', 'serverless', 'kubernetes', 'docker', 'infrastructure', 'iaas', 'paas'],
            'SaaS software': ['saas', 'software', 'enterprise', 'salesforce', 'microsoft', 'adobe', 'slack', 'zoom', 'teams', 'productivity'],
            'programming developer': ['programming', 'developer', 'code', 'github', 'api', 'framework', 'javascript', 'python', 'rust', 'typescript', 'devops'],
            'open source': ['open source', 'linux', 'github', 'repo', 'fork', 'license', 'community', 'oss'],
            'social media': ['social media', 'twitter', 'instagram', 'tiktok', 'facebook', 'meta', 'threads', 'bluesky', 'snapchat', 'youtube', 'influencer', 'creator'],
            'streaming media': ['streaming', 'netflix', 'disney+', 'hulu', 'spotify', 'youtube', 'podcast', 'content creator', 'video'],
            'ecommerce': ['ecommerce', 'e-commerce', 'amazon', 'shopify', 'retail', 'marketplace', 'delivery', 'logistics'],
            'fintech cryptocurrency': ['fintech', 'crypto', 'bitcoin', 'ethereum', 'blockchain', 'defi', 'nft', 'payment', 'banking', 'digital currency'],
            'cybersecurity': ['security', 'cyber', 'hack', 'breach', 'vulnerability', 'malware', 'ransomware', 'encryption', 'firewall', 'zero-day', 'phishing'],
            'data privacy': ['privacy', 'gdpr', 'data protection', 'surveillance', 'tracking', 'consent', 'regulation', 'personal data'],
            'semiconductors chips': ['semiconductor', 'chip', 'nvidia', 'intel', 'amd', 'tsmc', 'processor', 'cpu', 'gpu', 'silicon', 'fab'],
            'startups venture capital': ['startup', 'venture', 'funding', 'seed', 'series a', 'ipo', 'unicorn', 'accelerator', 'incubator', 'valuation'],
            'big tech FAANG': ['google', 'apple', 'amazon', 'meta', 'microsoft', 'nvidia', 'alphabet', 'big tech', 'antitrust', 'regulation'],
            'space technology': ['space', 'spacex', 'nasa', 'satellite', 'rocket', 'orbit', 'mars', 'lunar', 'starlink', 'blue origin'],
            'quantum computing': ['quantum', 'qubit', 'quantum computing', 'ibm quantum', 'quantum supremacy'],
            'biotech health tech': ['biotech', 'health tech', 'healthcare', 'medical', 'genomics', 'wearable health', 'telemedicine', 'pharma', 'clinical'],
            'AR VR metaverse': ['ar', 'vr', 'metaverse', 'augmented reality', 'virtual reality', 'mixed reality', 'headset', 'vision pro', 'quest', 'spatial'],
            'blockchain web3': ['blockchain', 'web3', 'decentralized', 'smart contract', 'dao', 'token', 'nft', 'defi', 'ethereum'],
            // Advertising & Marketing
            'advertising marketing': ['advertising', 'marketing', 'ad', 'campaign', 'brand', 'agency', 'cm–æ', 'programmatic', 'media buy', 'creative', 'adweek', 'ad age', 'digiday', 'adtech'],
            'brand marketing': ['brand', 'branding', 'campaign', 'awareness', 'loyalty', 'positioning', 'rebrand', 'sponsor', 'partnership', 'endorsement'],
            'digital advertising adtech': ['adtech', 'programmatic', 'display', 'retarget', 'cpm', 'cpc', 'dsp', 'ssp', 'ad exchange', 'ad network', 'google ads', 'meta ads', 'digital advertising'],
            'influencer creator economy': ['influencer', 'creator', 'creator economy', 'youtube', 'tiktok', 'instagram', 'sponsorship', 'brand deal', 'content creator', 'ugc', 'monetiz'],
            // Television & Streaming
            'television streaming': ['streaming', 'television', 'tv', 'netflix', 'disney+', 'hulu', 'hbo', 'max', 'peacock', 'paramount+', 'apple tv', 'amazon prime video', 'ratings', 'series', 'showrunner', 'viewership'],
            'streaming wars': ['streaming war', 'subscriber', 'churn', 'bundle', 'ad-supported', 'avod', 'svod', 'netflix', 'disney', 'hbo', 'peacock', 'paramount', 'tubi', 'pluto'],
            'connected TV advertising': ['connected tv', 'ctv', 'ott', 'addressable', 'smart tv', 'roku', 'fire tv', 'samsung tv', 'lg tv', 'ad-supported streaming', 'avod', 'fast channel'],
            // AI Deep Dive
            'AI blogs research': ['ai research', 'paper', 'arxiv', 'deepmind', 'openai', 'anthropic', 'google brain', 'benchmark', 'transformer', 'foundation model', 'alignment', 'agi', 'safety', 'llm'],
            'AI startups tools': ['ai startup', 'ai tool', 'ai app', 'ai platform', 'ai funding', 'ai company', 'series a', 'seed round', 'yc', 'launch', 'product hunt', 'ai agent', 'copilot', 'assistant'],
            'AI regulation policy': ['ai regulation', 'ai policy', 'ai act', 'ai governance', 'ai ethics', 'ai safety', 'ai bill', 'ai executive order', 'eu ai', 'responsible ai', 'bias', 'audit']
        };

        // =============================================
        // SMART SUMMARY GENERATOR
        // Uses the RSS description to build genuinely
        // informative 2-4 sentence summaries with a
        // casual-but-professional, newsy tone.
        // =============================================
        function buildSmartSummary(article, lang) {
            const title = article.title;
            const source = article.source;
            const raw = (article.rawSummary || '').replace(/<[^>]*>/g, '').trim();

            // Extract key details from the RSS description
            const sentences = raw.split(/(?<=[.!?])\s+/).filter(s => s.length > 20 && s.length < 300);
            const keyDetail = sentences.length > 0 ? sentences[0] : '';
            const extraDetail = sentences.length > 1 ? sentences[1] : '';

            // Shorten to usable snippets
            const detail1 = keyDetail.length > 180 ? keyDetail.substring(0, 177) + '...' : keyDetail;
            const detail2 = extraDetail.length > 150 ? extraDetail.substring(0, 147) + '...' : extraDetail;

            if (lang === 'es') {
                return buildSummaryES(title, source, detail1, detail2);
            }
            return buildSummaryEN(title, source, detail1, detail2);
        }

        function buildSummaryEN(title, source, detail1, detail2) {
            // Pick a random template set (each produces 2-4 sentences)
            const templates = [
                () => {
                    let s = `Here's the deal: ${source} is reporting on "${title}."`;
                    if (detail1) s += ` ${detail1}`;
                    if (detail2) s += ` ${detail2}`;
                    s += ` Worth keeping an eye on ‚Äî this one could have ripple effects across the industry.`;
                    return s;
                },
                () => {
                    let s = `${source} just dropped a piece on "${title}" and it's getting attention.`;
                    if (detail1) s += ` ${detail1}`;
                    if (detail2) s += ` ${detail2}`;
                    else s += ` The story touches on some key shifts happening in the tech landscape right now.`;
                    s += ` Definitely one to read if you want to stay in the loop.`;
                    return s;
                },
                () => {
                    let s = `Big story alert: "${title}" is making the rounds.`;
                    if (detail1) s += ` According to ${source}, ${detail1.charAt(0).toLowerCase() + detail1.slice(1)}`;
                    if (detail2) s += ` ${detail2}`;
                    s += ` This is the kind of development that shapes where the industry is headed.`;
                    return s;
                },
                () => {
                    let s = `Interesting one from ${source} ‚Äî "${title}."`;
                    if (detail1) s += ` ${detail1}`;
                    s += detail2 ? ` ${detail2}` : ` The implications here go beyond the headline, so it's worth digging into the full story.`;
                    s += ` Keep this on your radar.`;
                    return s;
                },
                () => {
                    let s = `${source} is covering "${title}" and here's why it matters.`;
                    if (detail1) s += ` ${detail1}`;
                    if (detail2) s += ` ${detail2}`;
                    s += ` If you're tracking the tech space, this is one you don't want to miss.`;
                    return s;
                }
            ];

            return templates[Math.floor(Math.random() * templates.length)]();
        }

        function buildSummaryES(title, source, detail1, detail2) {
            const templates = [
                () => {
                    let s = `Esto es lo importante: ${source} est√° reportando sobre "${title}."`;
                    if (detail1) s += ` ${detail1}`;
                    if (detail2) s += ` ${detail2}`;
                    s += ` Vale la pena seguirle la pista ‚Äî podr√≠a tener un efecto domin√≥ en toda la industria.`;
                    return s;
                },
                () => {
                    let s = `${source} acaba de publicar una nota sobre "${title}" y est√° generando atenci√≥n.`;
                    if (detail1) s += ` ${detail1}`;
                    if (detail2) s += ` ${detail2}`;
                    else s += ` La historia toca algunos cambios clave que est√°n ocurriendo en el panorama tecnol√≥gico.`;
                    s += ` Lectura recomendada si quieres mantenerte al d√≠a.`;
                    return s;
                },
                () => {
                    let s = `Noticia importante: "${title}" est√° circulando con fuerza.`;
                    if (detail1) s += ` Seg√∫n ${source}, ${detail1.charAt(0).toLowerCase() + detail1.slice(1)}`;
                    if (detail2) s += ` ${detail2}`;
                    s += ` Este es el tipo de desarrollo que marca hacia d√≥nde va la industria.`;
                    return s;
                },
                () => {
                    let s = `Una nota interesante de ${source} ‚Äî "${title}."`;
                    if (detail1) s += ` ${detail1}`;
                    s += detail2 ? ` ${detail2}` : ` Las implicaciones van m√°s all√° del titular, as√≠ que vale la pena leer la historia completa.`;
                    s += ` Tenlo en el radar.`;
                    return s;
                },
                () => {
                    let s = `${source} est√° cubriendo "${title}" y esto es por qu√© importa.`;
                    if (detail1) s += ` ${detail1}`;
                    if (detail2) s += ` ${detail2}`;
                    s += ` Si sigues el mundo tech, esta noticia no te la puedes perder.`;
                    return s;
                }
            ];

            return templates[Math.floor(Math.random() * templates.length)]();
        }

        // Source groups for the dropdown
        const SOURCE_GROUPS = [
            { label: 'General Tech', slugs: ['techmeme','techcrunch','theverge','zdnet','axios','googlenews'] },
            { label: 'Business & Finance', slugs: ['bloomberg','wsj'] },
            { label: 'Advertising & Marketing', slugs: ['adweek','adage','marketingdive','digiday'] },
            { label: 'Television & Streaming', slugs: ['variety','deadline','hollywoodreporter','tvrev'] },
            { label: 'AI Blogs', slugs: ['theneuron','openai','mittechreview','venturebeat','googleblog'] }
        ];

        // Track selected sources (all selected by default)
        let selectedSources = new Set(NEWS_SOURCES.map(s => s.slug));

        // Build the source checkboxes
        function buildSourceCheckboxes() {
            const container = document.getElementById('sourceCheckboxes');
            let html = '';
            SOURCE_GROUPS.forEach(group => {
                html += `<div class="src-group-label">${group.label}</div>`;
                group.slugs.forEach(slug => {
                    const src = NEWS_SOURCES.find(s => s.slug === slug);
                    if (!src) return;
                    html += `
                        <label class="src-option" onclick="event.stopPropagation()">
                            <input type="checkbox" checked data-slug="${src.slug}" onchange="onSourceToggle()">
                            <span class="src-dot" style="background:${src.color}"></span>
                            ${src.name}
                        </label>`;
                });
            });
            container.innerHTML = html;
        }
        buildSourceCheckboxes();

        function toggleSourceDropdown() {
            const panel = document.getElementById('sourcePanel');
            const trigger = document.getElementById('sourceTrigger');
            const isOpen = panel.classList.contains('open');
            panel.classList.toggle('open');
            trigger.classList.toggle('open');
            if (!isOpen) {
                // Close on outside click
                setTimeout(() => {
                    document.addEventListener('click', closeSourceDropdownOutside);
                }, 0);
            }
        }

        function closeSourceDropdownOutside(e) {
            const dropdown = document.getElementById('sourceDropdown');
            if (!dropdown.contains(e.target)) {
                document.getElementById('sourcePanel').classList.remove('open');
                document.getElementById('sourceTrigger').classList.remove('open');
                document.removeEventListener('click', closeSourceDropdownOutside);
            }
        }

        function onSourceToggle() {
            selectedSources.clear();
            document.querySelectorAll('#sourceCheckboxes input[type="checkbox"]').forEach(cb => {
                if (cb.checked) selectedSources.add(cb.dataset.slug);
            });
            updateSourceTriggerLabel();
        }

        function selectAllSources() {
            document.querySelectorAll('#sourceCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
            selectedSources = new Set(NEWS_SOURCES.map(s => s.slug));
            updateSourceTriggerLabel();
        }

        function deselectAllSources() {
            document.querySelectorAll('#sourceCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
            selectedSources.clear();
            updateSourceTriggerLabel();
        }

        function updateSourceTriggerLabel() {
            const trigger = document.getElementById('sourceTrigger');
            const badge = document.getElementById('sourceCountBadge');
            const total = NEWS_SOURCES.length;
            const count = selectedSources.size;
            badge.textContent = count;

            if (count === 0) {
                trigger.innerHTML = `No sources selected <span class="source-count-badge" id="sourceCountBadge">0</span>`;
            } else if (count === total) {
                trigger.innerHTML = `All Sources Selected <span class="source-count-badge" id="sourceCountBadge">${total}</span>`;
            } else if (count <= 3) {
                const names = NEWS_SOURCES.filter(s => selectedSources.has(s.slug)).map(s => s.name).join(', ');
                trigger.innerHTML = `${names} <span class="source-count-badge" id="sourceCountBadge">${count}</span>`;
            } else {
                trigger.innerHTML = `${count} sources selected <span class="source-count-badge" id="sourceCountBadge">${count}</span>`;
            }
        }

        // Language toggle
        function setLanguage(lang, el) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            // Re-render to update existing summaries
            if (displayedArticles.length > 0) renderNews();
            showToast(lang === 'en' ? 'Language: English' : 'Idioma: Espa√±ol');
        }

        // Topic change
        function onTopicChange() {
            currentTopic = document.getElementById('topicSelect').value;
        }

        // Fetch news from all sources
        async function fetchNews() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('loading');
            btn.disabled = true;

            const selectedTopic = document.getElementById('topicSelect').value;
            currentTopic = selectedTopic;
            const topicOption = document.getElementById('topicSelect').selectedOptions[0];
            const topicLabel = topicOption.textContent.trim();

            // Filter to only selected sources
            const activeSources = NEWS_SOURCES.filter(s => selectedSources.has(s.slug));

            if (activeSources.length === 0) {
                const container = document.getElementById('newsContainer');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <h2 style="margin-bottom:8px; color:var(--text-primary);">No sources selected</h2>
                        <p>Open the <strong>Sources</strong> dropdown above and check at least one source to fetch from.</p>
                    </div>`;
                btn.classList.remove('loading');
                btn.disabled = false;
                return;
            }

            const container = document.getElementById('newsContainer');
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading-dots"><span></span><span></span><span></span></div>
                    <div class="loading-text">Fetching ${selectedTopic === 'all' ? 'all tech' : topicLabel} news from ${activeSources.length} source${activeSources.length !== 1 ? 's' : ''}...</div>
                </div>
            `;

            allArticles = [];

            const promises = activeSources.map(async (source) => {
                try {
                    const resp = await fetch(CORS_PROXY + encodeURIComponent(source.rss));
                    if (!resp.ok) throw new Error('Fetch failed');
                    const data = await resp.json();
                    if (data.status === 'ok' && data.items) {
                        return data.items.slice(0, 50).map(item => ({
                            title: cleanHTML(item.title),
                            link: item.link,
                            rawSummary: cleanHTML(item.description || item.content || ''),
                            summary: cleanHTML(item.description || item.content || '').slice(0, 400),
                            pubDate: new Date(item.pubDate),
                            source: source.name,
                            slug: source.slug,
                            color: source.color,
                            aiSummary: null
                        }));
                    }
                } catch (e) {
                    console.warn(`Failed to fetch ${source.name}:`, e.message);
                    try {
                        const altResp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(source.rss)}`);
                        const altData = await altResp.json();
                        if (altData.contents) {
                            return parseRSSXML(altData.contents, source);
                        }
                    } catch(e2) {
                        console.warn(`Alt fetch also failed for ${source.name}`);
                    }
                }
                return [];
            });

            const results = await Promise.allSettled(promises);
            results.forEach(r => {
                if (r.status === 'fulfilled' && r.value) {
                    allArticles.push(...r.value);
                }
            });

            // Sort by recency and deduplicate
            allArticles.sort((a, b) => b.pubDate - a.pubDate);
            allArticles = deduplicateArticles(allArticles);

            // Filter by topic if not "all"
            if (selectedTopic !== 'all') {
                const keywords = TOPIC_KEYWORDS[selectedTopic] || selectedTopic.toLowerCase().split(' ');
                allArticles = allArticles.filter(article => {
                    const text = (article.title + ' ' + article.summary).toLowerCase();
                    return keywords.some(kw => text.includes(kw.toLowerCase()));
                });
            }

            // Take top 50
            displayedArticles = allArticles.slice(0, 50);

            renderNews();
            updateStats(topicLabel);

            btn.classList.remove('loading');
            btn.disabled = false;
            document.getElementById('lastUpdated').textContent =
                `Updated: ${new Date().toLocaleString('en-US', {hour: '2-digit', minute: '2-digit', timeZone: 'America/Puerto_Rico'})} AST`;
        }

        // Parse RSS XML manually as fallback
        function parseRSSXML(xmlText, source) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlText, 'text/xml');
            const items = doc.querySelectorAll('item, entry');
            const articles = [];
            items.forEach((item, i) => {
                if (i >= 15) return;
                const title = item.querySelector('title')?.textContent || '';
                const link = item.querySelector('link')?.textContent ||
                             item.querySelector('link')?.getAttribute('href') || '';
                const desc = item.querySelector('description, summary, content')?.textContent || '';
                const pubDate = item.querySelector('pubDate, published, updated')?.textContent || '';
                articles.push({
                    title: cleanHTML(title),
                    link: link.trim(),
                    rawSummary: cleanHTML(desc),
                    summary: cleanHTML(desc).slice(0, 400),
                    pubDate: pubDate ? new Date(pubDate) : new Date(),
                    source: source.name,
                    slug: source.slug,
                    color: source.color,
                    aiSummary: null
                });
            });
            return articles;
        }

        function cleanHTML(str) {
            const div = document.createElement('div');
            div.innerHTML = str;
            return div.textContent || div.innerText || '';
        }

        function deduplicateArticles(articles) {
            const seen = [];
            return articles.filter(a => {
                const normalized = a.title.toLowerCase().replace(/[^a-z0-9]/g, '');
                const isDupe = seen.some(s => {
                    const overlap = longestCommon(s, normalized);
                    return overlap > normalized.length * 0.6;
                });
                if (!isDupe) {
                    seen.push(normalized);
                    return true;
                }
                return false;
            });
        }

        function longestCommon(s1, s2) {
            let count = 0;
            const words1 = s1.split(/\s+/);
            const words2Set = new Set(s2.split(/\s+/));
            words1.forEach(w => { if (words2Set.has(w)) count += w.length; });
            return count;
        }

        // Render news cards
        function renderNews() {
            const container = document.getElementById('newsContainer');
            const filtered = displayedArticles;

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <h2 style="margin-bottom:8px; color:var(--text-primary);">No articles found for this topic</h2>
                        <p>Try selecting "All Technology" or a broader topic, then fetch again.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="news-grid">' + filtered.map((article, i) => {
                const summaryText = article.summary.replace(/<[^>]*>/g, '');
                const displaySummary = summaryText.substring(0, 300) + (summaryText.length > 300 ? '...' : '');

                return `
                <div class="news-card" data-source="${article.slug}" id="card-${i}">
                    <div class="card-top-row">
                        <div class="card-rank ${i < 3 ? 'top3' : ''}">${i + 1}</div>
                        <div class="card-content">
                            <div class="card-source-row">
                                <span class="source-badge" style="background:${article.color}22; color:${article.color}">${article.source}</span>
                                <span class="card-time"><span class="pub-date">${formatPubDate(article.pubDate)}</span><span class="time-sep">¬∑</span>${timeAgo(article.pubDate)}</span>
                            </div>
                            <div class="card-headline">
                                <a href="${article.link}" target="_blank" rel="noopener">${article.title}</a>
                            </div>
                            ${displaySummary ? `<div class="card-summary">${displaySummary}</div>` : ''}
                        </div>
                        <div class="card-actions">
                            <button class="share-btn summary-btn" title="Generate quick summary" onclick='generateQuickSummary(${i})'>
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                Summary
                            </button>
                            <button class="share-btn linkedin" title="Post to LinkedIn" onclick='openShareModal(${i}, "linkedin")'>
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                            </button>
                            <button class="share-btn twitter" title="Post to X" onclick='openShareModal(${i}, "twitter")'>
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                            </button>
                            <button class="share-btn threads" title="Post to Threads" onclick='openShareModal(${i}, "threads")'>
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18 0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.59 12c.025 3.086.718 5.496 2.057 7.164 1.432 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.34-.776-.94-1.394-1.738-1.79a7.7 7.7 0 01-.163 2.134c-.342 1.604-1.078 2.852-2.13 3.606-1.02.733-2.29 1.05-3.676.918-1.018-.098-1.94-.465-2.664-1.065-.81-.67-1.286-1.58-1.339-2.56-.098-1.822 1.35-3.324 4.063-4.222 1.588-.525 3.04-.664 4.334-.427-.125-.65-.387-1.186-.79-1.59-.562-.565-1.398-.852-2.484-.855h-.03c-.876.003-1.588.235-2.115.69l-1.378-1.525c.87-.753 1.98-1.15 3.463-1.165h.043c1.576.007 2.788.446 3.602 1.3.728.763 1.142 1.793 1.26 3.084.558.178 1.065.418 1.517.716.858.563 1.527 1.357 1.942 2.311.757 1.737.849 4.413-1.19 6.41-1.752 1.718-3.894 2.47-6.946 2.494zm-1.065-7.9c-1.833.607-2.735 1.49-2.692 2.295.022.39.207.72.534.952.41.292.932.438 1.55.496.984.092 1.873-.129 2.575-.64.717-.52 1.236-1.399 1.5-2.547.162-.697.2-1.404.12-2.098-1.076-.216-2.27-.131-3.587.341v.201z"/></svg>
                            </button>
                            <button class="share-btn copy" title="Copy headline" onclick='copyHeadline(${JSON.stringify(article.title).replace(/'/g, "&#39;")}, "${article.link}")'>
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div id="summary-panel-${i}"></div>
                </div>`;
            }).join('') + '</div>';
        }

        // Generate quick summary for an article
        function generateQuickSummary(index) {
            const article = displayedArticles[index];
            const panel = document.getElementById(`summary-panel-${index}`);
            const btn = document.querySelector(`#card-${index} .summary-btn`);

            // Toggle off if already showing
            if (panel.innerHTML) {
                panel.innerHTML = '';
                return;
            }

            // Show loading
            btn.classList.add('loading-summary');
            btn.innerHTML = `<span class="spinner" style="display:inline-block;width:12px;height:12px;border:2px solid var(--text-muted);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;"></span> ...`;

            // Simulate a brief delay to feel like generation
            setTimeout(() => {
                const summary = buildSmartSummary(article, currentLanguage);

                const langLabel = currentLanguage === 'es' ? 'Resumen r√°pido' : 'Quick Summary';
                const closeBtnTitle = currentLanguage === 'es' ? 'Cerrar' : 'Close';

                panel.innerHTML = `
                    <div class="card-ai-summary">
                        <div class="summary-header">
                            <span class="summary-label">${langLabel}</span>
                            <button class="summary-close" title="${closeBtnTitle}" onclick="document.getElementById('summary-panel-${index}').innerHTML=''">‚úï</button>
                        </div>
                        <div class="summary-text">${summary}</div>
                    </div>
                `;

                // Restore button
                btn.classList.remove('loading-summary');
                btn.innerHTML = `<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg> Summary`;
            }, 600);
        }

        function updateStats(topicLabel) {
            document.getElementById('statsBar').style.display = 'flex';
            document.getElementById('statArticles').textContent = displayedArticles.length;
            const sources = new Set(displayedArticles.map(a => a.source));
            document.getElementById('statSources').textContent = sources.size;

            const badge = document.getElementById('topicBadge');
            if (currentTopic !== 'all') {
                badge.style.display = 'flex';
                document.getElementById('topicBadgeText').textContent = topicLabel || currentTopic;
                const opt = document.getElementById('topicSelect').selectedOptions[0];
                const emoji = opt ? opt.textContent.trim().split(' ')[0] : 'üîç';
                document.getElementById('topicBadgeIcon').textContent = emoji;
            } else {
                badge.style.display = 'none';
            }
        }

        function timeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
            return `${Math.floor(diff/86400)}d ago`;
        }

        function formatPubDate(date) {
            if (!date || isNaN(date)) return '';
            // Convert to Atlantic Standard Time (AST = UTC-4)
            const ast = new Date(date.getTime() + (date.getTimezoneOffset() * 60000) - (4 * 3600000));
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const m = months[ast.getMonth()];
            const d = ast.getDate();
            const y = ast.getFullYear();
            let h = ast.getHours();
            const min = ast.getMinutes().toString().padStart(2, '0');
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${m} ${d}, ${y} at ${h}:${min} ${ampm} AST`;
        }

        // Social Post Modal ‚Äî now uses index
        function openShareModal(index, platform) {
            currentArticle = displayedArticles[index];
            currentPlatform = platform;

            document.querySelectorAll('.modal-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.platform === platform);
            });

            generatePost();
            document.getElementById('modalOverlay').classList.add('active');
        }

        function generatePost() {
            const a = currentArticle;
            let post = '';

            if (currentPlatform === 'linkedin') {
                const templates = [
                    `Interesting development in tech:\n\n"${a.title}"\n\n${a.summary ? a.summary.substring(0, 180) + '...' : ''}\n\nThis is worth watching for anyone in the tech space.\n\n${a.link}`,
                    `Worth reading today:\n\n${a.title}\n\n${a.summary ? 'Key takeaway: ' + a.summary.substring(0, 160) + '...' : ''}\n\nWhat are your thoughts on this?\n\n${a.link}`,
                    `Just came across this:\n\n${a.title}\n\n${a.summary ? a.summary.substring(0, 180) : ''}\n\nI think this signals an important trend. Thoughts?\n\n${a.link}`,
                    `This caught my attention:\n\n"${a.title}"\n\n${a.summary ? a.summary.substring(0, 180) + '...' : ''}\n\nThe implications here are bigger than they seem at first glance.\n\n${a.link}`,
                    `If you're in tech, this one's worth a read:\n\n${a.title}\n\n${a.summary ? a.summary.substring(0, 160) + '...' : ''}\n\nWould love to hear how others see this playing out.\n\n${a.link}`
                ];
                post = templates[Math.floor(Math.random() * templates.length)];
            } else if (currentPlatform === 'threads') {
                const templates = [
                    `${a.title}\n\n${a.summary ? a.summary.substring(0, 200) + '...' : ''}\n\nFull story: ${a.link}`,
                    `This is worth paying attention to:\n\n${a.title}\n\n${a.summary ? a.summary.substring(0, 160) + '...' : ''}\n\n${a.link}`,
                    `Just caught this:\n\n"${a.title}"\n\n${a.summary ? a.summary.substring(0, 180) : ''}\n\n${a.link}`,
                    `If you follow tech, read this one:\n\n${a.title}\n\n${a.summary ? a.summary.substring(0, 140) + '...' : ''}\n\nThoughts?\n\n${a.link}`,
                    `Big news in tech today:\n\n${a.title}\n\n${a.summary ? a.summary.substring(0, 180) + '...' : ''}\n\n${a.link}`
                ];
                post = templates[Math.floor(Math.random() * templates.length)];
            } else {
                const templates = [
                    `${a.title}\n\n${a.summary ? a.summary.substring(0, 120) + '...' : ''}\n\n${a.link}`,
                    `Worth reading: ${a.title}\n\n${a.link}`,
                    `${a.title}\n\nThoughts?\n\n${a.link}`,
                    `This is a big one: ${a.title}\n\n${a.link}`,
                    `Interesting development ‚Äî ${a.title}\n\n${a.summary ? a.summary.substring(0, 80) + '...' : ''}\n\n${a.link}`
                ];
                post = templates[Math.floor(Math.random() * templates.length)];
            }

            document.getElementById('postText').value = post;
            updateCharCount();
        }

        function switchTab(platform, el) {
            currentPlatform = platform;
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            generatePost();
        }

        function updateCharCount() {
            const text = document.getElementById('postText').value;
            const limit = currentPlatform === 'twitter' ? 280 : currentPlatform === 'threads' ? 500 : 3000;
            const counter = document.getElementById('charCount');
            counter.textContent = `${text.length} / ${limit}`;
            counter.classList.toggle('over', text.length > limit);
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function closeModalOutside(e) {
            if (e.target === document.getElementById('modalOverlay')) closeModal();
        }

        async function copyPost() {
            const text = document.getElementById('postText').value;
            await navigator.clipboard.writeText(text);
            showToast('Post copied to clipboard!');
        }

        function openPlatform() {
            const text = encodeURIComponent(document.getElementById('postText').value);
            if (currentPlatform === 'linkedin') {
                window.open(`https://www.linkedin.com/feed/?shareActive=true`, '_blank');
                navigator.clipboard.writeText(document.getElementById('postText').value);
                showToast('Post copied! Paste it in LinkedIn.');
            } else if (currentPlatform === 'threads') {
                window.open(`https://www.threads.net/intent/post?text=${text}`, '_blank');
            } else {
                window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
            }
            closeModal();
        }

        function copyHeadline(title, link) {
            navigator.clipboard.writeText(`${title}\n${link}`);
            showToast('Headline & link copied!');
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
            if (e.key === 'r' && !e.ctrlKey && !e.metaKey &&
                document.activeElement.tagName !== 'TEXTAREA' &&
                document.activeElement.tagName !== 'SELECT') {
                fetchNews();
            }
        });
    </script>
</body>
</html>
